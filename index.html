<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MINER 50W - FIXED ECO</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050508; --pnl: #11111d; --acc: #00ff88; --gold: #ffcc00; --xp: #bb00ff; --evt: #ff4444; }
        * { box-sizing: border-box; font-family: 'Rajdhani', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 99999; display: flex; align-items: center; justify-content: center; }
        .auth-box { width: 85%; max-width: 350px; background: var(--pnl); padding: 25px; border-radius: 15px; border: 1px solid var(--acc); }

        header { background: #000; padding: 10px; border-bottom: 2px solid var(--acc); display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .stat-card { background: #111; padding: 5px; border-radius: 5px; text-align: center; border: 1px solid #222; }
        .stat-val { display: block; font-weight: bold; color: var(--acc); font-size: 14px; }
        .xp-cont { grid-column: span 3; background: #222; height: 18px; border-radius: 9px; margin-top: 5px; overflow: hidden; position: relative; border: 1px solid #444; }
        #xp-bar { background: var(--xp); height: 100%; width: 0%; transition: 0.3s; }
        #xp-txt { position: absolute; width: 100%; text-align: center; font-size: 11px; font-weight: bold; line-height: 18px; text-shadow: 1px 1px #000; }

        #event-banner { background: var(--evt); color: #fff; text-align: center; font-weight: bold; padding: 5px; font-size: 12px; display: none; border-bottom: 1px solid #fff; }

        .content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        .tab { display: none; } .tab.active { display: block; }
        
        .game-card { background: var(--pnl); border-radius: 10px; padding: 12px; margin-bottom: 10px; border-left: 4px solid var(--acc); }
        .locked { opacity: 0.5; filter: grayscale(1); }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-bottom: 5px; }
        .btn-main { background: var(--acc); color: #000; }
        .btn-sub { background: #222; color: #fff; border: 1px solid #444; }

        nav { background: #000; height: 65px; display: flex; border-top: 1px solid #333; position: fixed; bottom: 0; width: 100%; z-index: 100; }
        .nav-item { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #444; }
        .nav-item.active { color: var(--acc); border-top: 2px solid var(--acc); }

        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 5px; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:10000; padding:20px; overflow-y: auto; }
        
        .rank-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .rank-table th { color: var(--acc); text-align: left; padding: 8px; border-bottom: 1px solid #333; }
        .rank-table td { padding: 8px; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-box">
        <h2 style="color:var(--acc); text-align:center;">MINER 50W</h2>
        <input type="text" id="login-user" placeholder="USU√ÅRIO">
        <input type="password" id="login-pass" placeholder="SENHA">
        <button class="btn btn-main" onclick="core.auth('login')">ENTRAR</button>
        <button class="btn btn-sub" onclick="core.auth('reg')">CRIAR CONTA</button>
    </div>
</div>

<div id="event-banner">EVENTO ATIVO: <span id="evt-name">...</span> (<span id="evt-timer">0</span>s)</div>

<header>
    <div class="stat-card">LV <span class="stat-val" id="st-lv">1</span></div>
    <div class="stat-card">MUNDO <span class="stat-val" id="st-world">1/50</span></div>
    <div class="stat-card">RB <span class="stat-val" id="st-rb">0</span></div>
    <div class="stat-card" style="grid-column: span 2;">$ <span class="stat-val" id="st-money" style="color:var(--gold)">0</span></div>
    <div class="stat-card">BAG <span class="stat-val" id="st-bag">0</span></div>
    <div class="xp-cont">
        <div id="xp-bar"></div>
        <div id="xp-txt">0 / 100</div>
    </div>
</header>

<div class="content">
    <div id="tab-mine" class="tab active">
        <div style="text-align:center; padding:20px 0;">
            <div id="click-area" onclick="core.mine()" style="font-size:100px; cursor:pointer;">‚õèÔ∏è</div>
            <button class="btn btn-main" style="margin-top:20px; padding:20px;" onclick="core.sell()">VENDER MIN√âRIOS</button>
        </div>
        <div class="game-card"><div id="pet-summary">üêæ 0 PETS (+0 PWR)</div></div>
    </div>

    <div id="tab-worlds" class="tab">
        <h3 style="color:var(--acc)">MUNDOS (50)</h3>
        <div id="world-list"></div>
    </div>

    <div id="tab-eggs" class="tab">
        <h3 style="color:var(--acc)">LOJA DE OVOS (30)</h3>
        <div id="egg-list"></div>
    </div>

    <div id="tab-rank" class="tab">
        <table class="rank-table">
            <thead><tr><th>JOGADOR</th><th>LV</th><th>MUNDO</th><th>$</th></tr></thead>
            <tbody id="rank-body"></tbody>
        </table>
    </div>

    <div id="tab-chat" class="tab">
        <div id="chat-box" style="height:300px; background:#000; overflow-y:auto; padding:10px; border:1px solid #222; margin-bottom:10px;"></div>
        <div style="display:flex; gap:5px;"><input type="text" id="chat-in" placeholder="Diga algo..."><button class="btn btn-main" style="width:70px;" onclick="core.sendMsg()">OK</button></div>
    </div>
</div>

<div id="modal-admin" class="modal">
    <div class="game-card">
        <h2 style="color:var(--xp)">PAINEL MESTRE</h2>
        <h3 style="color:var(--evt)">EVENTO GLOBAL</h3>
        <input type="text" id="evt-title" placeholder="NOME DO EVENTO">
        <input type="number" id="evt-time" placeholder="TEMPO (S)">
        <input type="number" id="evt-mult" placeholder="MULT (EX: 2)">
        <select id="evt-type">
            <option value="both">DINHEIRO E XP</option>
            <option value="gold">S√ì DINHEIRO</option>
            <option value="xp">S√ì XP</option>
        </select>
        <button class="btn btn-main" style="background:var(--evt); color:#fff;" onclick="core.startEvent()">LAN√áAR EVENTO</button>
        <hr style="border:0; border-top:1px solid #444; margin: 15px 0;">
        <select id="adm-target"><option value="ALL">TODOS</option></select>
        <input type="text" id="adm-cash-val" placeholder="QUANTIA (EX: 1M)">
        <button class="btn btn-main" onclick="core.admGive()">DAR DINHEIRO</button>
        <button class="btn btn-sub" style="width:100%;" onclick="document.getElementById('modal-admin').style.display='none'">FECHAR</button>
    </div>
</div>

<nav>
    <div class="nav-item active" onclick="core.tab('tab-mine', this)">‚õèÔ∏è</div>
    <div class="nav-item" onclick="core.tab('tab-worlds', this)">üåç</div>
    <div class="nav-item" onclick="core.tab('tab-eggs', this)">ü•ö</div>
    <div class="nav-item" onclick="core.tab('tab-rank', this)">üèÜ</div>
    <div class="nav-item" onclick="core.tab('tab-chat', this)">üí¨</div>
</nav>

<script>
const core = {
    data: { user:'', gold:0, bag:0, xp:0, lv:1, world:1, rb:0, ups:{f:0, m:0, a:0}, pets:[] },
    players: [],
    chan: null,
    event: { active: false, time: 0, mult: 1, type: 'both', name: '' },
    suffixes: ["", "K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc"],

    f(n) {
        if (n < 1000) return Math.floor(n);
        let exp = Math.floor(Math.log10(n) / 3);
        if (exp >= this.suffixes.length) exp = this.suffixes.length - 1;
        return (n / Math.pow(1000, exp)).toFixed(2) + this.suffixes[exp];
    },

    parse(v) {
        let val = parseFloat(v);
        let s = String(v).toUpperCase();
        for(let i=1; i<this.suffixes.length; i++) if(s.includes(this.suffixes[i])) return val * Math.pow(1000, i);
        return val || 0;
    },

    auth(mode) {
        const u = document.getElementById('login-user').value.trim();
        const p = document.getElementById('login-pass').value.trim();
        if(!u) return;
        let db = JSON.parse(localStorage.getItem('M50W_FINAL') || '{}');
        if(mode === 'reg') { db[u] = { ...this.data, user:u, pass:p }; localStorage.setItem('M50W_FINAL', JSON.stringify(db)); alert("Conta Criada!"); }
        if(db[u] && db[u].pass === p) { this.data = db[u]; document.getElementById('auth-screen').style.display = 'none'; this.init(); }
    },

    init() {
        const ably = new Ably.Realtime('UhNj3w.aNaMJw:_GCHvcVsSZqK40m3oBBWiYisU6Sc2j6QU7mcD2QNI48');
        this.chan = ably.channels.get('v5_stable');
        this.chan.subscribe(m => {
            if(m.name === 'chat') this.addMsg(m.data.u, m.data.t);
            if(m.name === 'gift' && (m.data.to === 'ALL' || m.data.to === this.data.user)) { this.data.gold += m.data.v; this.updateUI(); }
            if(m.name === 'p') this.upPlayers(m.data);
            if(m.name === 'evt_start') this.triggerLocalEvent(m.data);
        });
        
        setInterval(() => this.tickEvent(), 1000);
        setInterval(() => { this.chan.publish('p', { u: this.data.user, l: this.data.lv, w: this.data.world, g: this.data.gold }); }, 4000);
        this.renderAll();
        this.updateUI();
    },

    mine() {
        let pwr = 1;
        this.data.pets.forEach(p => pwr += p.m);
        this.data.bag += pwr;
        
        let xpGain = pwr;
        if(this.event.active && (this.event.type === 'xp' || this.event.type === 'both')) xpGain *= this.event.mult;
        
        this.data.xp += xpGain;
        this.check();
        this.updateUI();
    },

    sell() {
        // MUNDO 1 agora come√ßa dando 50 por min√©rio.
        let worldMult = 50 * Math.pow(25, this.data.world - 1);
        let eventMult = (this.event.active && (this.event.type === 'gold' || this.event.type === 'both')) ? this.event.mult : 1;
        
        this.data.gold += this.data.bag * worldMult * eventMult;
        this.data.bag = 0;
        this.updateUI();
        this.save();
    },

    check() {
        let next = 100 * Math.pow(this.data.lv, 1.4);
        if(this.data.xp >= next) {
            this.data.lv++;
            this.data.xp = 0;
            this.data.world = Math.min(50, Math.floor(this.data.lv / 20) + 1);
            this.renderAll();
        }
    },

    startEvent() {
        this.chan.publish('evt_start', {
            name: document.getElementById('evt-title').value || 'Evento',
            time: parseInt(document.getElementById('evt-time').value) || 60,
            mult: parseFloat(document.getElementById('evt-mult').value) || 2,
            type: document.getElementById('evt-type').value
        });
    },

    triggerLocalEvent(d) {
        this.event = { active: true, ...d };
        document.getElementById('event-banner').style.display = 'block';
        document.getElementById('evt-name').innerText = d.name.toUpperCase();
    },

    tickEvent() {
        if(this.event.active) {
            this.event.time--;
            document.getElementById('evt-timer').innerText = this.event.time;
            if(this.event.time <= 0) {
                this.event.active = false;
                document.getElementById('event-banner').style.display = 'none';
            }
        }
    },

    save() {
        let db = JSON.parse(localStorage.getItem('M50W_FINAL') || '{}');
        db[this.data.user] = this.data;
        localStorage.setItem('M50W_FINAL', JSON.stringify(db));
    },

    updateUI() {
        document.getElementById('st-money').innerText = this.f(this.data.gold);
        document.getElementById('st-bag').innerText = this.f(this.data.bag);
        document.getElementById('st-lv').innerText = this.data.lv;
        document.getElementById('st-world').innerText = this.data.world + "/50";
        let next = 100 * Math.pow(this.data.lv, 1.4);
        document.getElementById('xp-bar').style.width = (this.data.xp / next * 100) + "%";
        document.getElementById('xp-txt').innerText = `${this.f(this.data.xp)} / ${this.f(next)}`;
        let tp = 0; this.data.pets.forEach(p=>tp+=p.m);
        document.getElementById('pet-summary').innerText = `üêæ ${this.data.pets.length} PETS (+${this.f(tp)} PWR)`;
    },

    renderAll() {
        let e = '';
        for(let i=1; i<=30; i++) {
            let cost = 1000 * Math.pow(12, i-1);
            e += `<div class="game-card">ü•ö OVO ${i}<br><small>Pwr: +${this.f(Math.pow(8, i-1)*25)}</small><br><button class="btn btn-main" onclick="core.buyEgg(${i})">$${this.f(cost)}</button></div>`;
        }
        document.getElementById('egg-list').innerHTML = e;

        let w = '';
        const names = ["Terra", "Caverna", "Oceano", "Marte", "Vazio"];
        for(let i=1; i<=50; i++) {
            let req = (i-1) * 20;
            let isLocked = this.data.lv < req;
            w += `<div class="game-card ${isLocked ? 'locked' : ''}">
                <b>${i}. ${names[(i-1)%5]}</b><br>
                <small>REQ: LV ${req} | MULT: ${this.f(50 * Math.pow(25, i-1))}x</small>
            </div>`;
        }
        document.getElementById('world-list').innerHTML = w;
    },

    buyEgg(i) {
        let cost = 1000 * Math.pow(12, i-1);
        if(this.data.gold >= cost) {
            this.data.gold -= cost;
            this.data.pets.push({ m: Math.pow(8, i-1) * 25 });
            this.updateUI();
        }
    },

    upPlayers(p) {
        const idx = this.players.findIndex(x => x.u === p.u);
        if(idx > -1) this.players[idx] = p; else this.players.push(p);
        let sel = document.getElementById('adm-target');
        sel.innerHTML = '<option value="ALL">TODOS</option>';
        this.players.forEach(pl => sel.innerHTML += `<option value="${pl.u}">${pl.u}</option>`);
    },

    tab(id, el) {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        document.getElementById(id).classList.add('active'); el.classList.add('active');
        if(id === 'tab-rank') {
            document.getElementById('rank-body').innerHTML = this.players.sort((a,b)=>b.l - a.l).map(p=>`
                <tr><td>${p.u}</td><td>${p.l}</td><td>${p.w}</td><td style="color:var(--gold)">$${this.f(p.g)}</td></tr>
            `).join('');
        }
    },

    sendMsg() {
        let i = document.getElementById('chat-in');
        if(i.value === '/admin') return document.getElementById('modal-admin').style.display='block';
        this.chan.publish('chat', { u: this.data.user, t: i.value });
        i.value = '';
    },

    addMsg(u, t) {
        let b = document.getElementById('chat-box');
        b.innerHTML += `<div><b style="color:var(--acc)">${u}:</b> ${t}</div>`;
        b.scrollTop = b.scrollHeight;
    },

    admGive() {
        let to = document.getElementById('adm-target').value;
        let val = this.parse(document.getElementById('adm-cash-val').value);
        this.chan.publish('gift', { to, v: val });
    }
};
</script>
</body>
</html>
